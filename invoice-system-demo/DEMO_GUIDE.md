# 下一代开票系统 MVP Demo 演示指南

## 系统概述

本Demo演示了基于KDUBL和规则引擎的配置化开票系统核心功能：
- **业务规则引擎**：通过配置实现业务逻辑，无需修改代码
- **数据处理流程**：KDUBL ↔ Domain Object的转换和处理
- **模块化架构**：业务层与通道层分离

## 核心演示点

### 1. 配置化的业务规则

系统通过YAML配置文件定义业务规则，包括：

**字段补全规则**（自动填充缺失数据）：
- 设置默认国家
- 根据公司名称补全税号
- 计算税额和净额

**业务校验规则**（验证数据合法性）：
- 必填字段校验
- 金额范围校验
- 条件性校验（如大额发票必须有税号）

### 2. 规则引擎工作流程

```
输入KDUBL → 解析为Domain Object → 执行补全规则 → 执行校验规则 → 生成KDUBL
```

### 3. 演示场景

#### 场景1：自动补全税号
- 发票中客户名称为"金蝶广州"
- 系统自动补全税号"91440100MA5CYC7K8X"

#### 场景2：大额发票校验
- 当发票金额超过10000元时
- 系统要求必须填写客户税号

## 如何添加新规则

### 示例：添加一个新的补全规则

1. 编辑 `backend/config/rules.yaml`
2. 在 `field_completion_rules` 下添加：

```yaml
- id: "completion_007"
  rule_name: "补全特定商品税率"
  apply_to: "invoice.items[0].description == '咨询服务'"
  target_field: "items[0].tax_rate"
  rule_expression: "0.06"
  priority: 75
  active: true
```

3. 重启后端服务，规则立即生效

### 示例：添加一个新的校验规则

```yaml
- id: "validation_006"
  rule_name: "限制单笔金额"
  apply_to: ""
  field_path: "total_amount"
  rule_expression: "invoice.total_amount <= 100000"
  error_message: "单笔发票金额不能超过10万元"
  priority: 85
  active: true
```

## 技术亮点

1. **零代码扩展**：业务规则通过配置管理，新增规则无需修改代码
2. **简化版CEL表达式**：支持条件判断、字段访问、算术运算
3. **Domain Object模式**：提供类型安全的内存业务模型
4. **模块化设计**：各层职责清晰，易于扩展

## 后续扩展方向

1. **完整CEL支持**：集成Google CEL引擎，支持更复杂的表达式
2. **规则版本管理**：支持规则的版本控制和回滚
3. **可视化规则编辑器**：提供图形化的规则配置界面
4. **数据源集成**：实现从数据库、API等外部源补全数据
5. **实时规则更新**：无需重启即可加载新规则

## 运行Demo

1. 启动系统：`./start.sh`
2. 访问前端：http://localhost:3000
3. 上传示例发票或使用提供的测试数据
4. 观察规则引擎的执行过程和结果