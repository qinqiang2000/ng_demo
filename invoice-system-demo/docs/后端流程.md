## ğŸ”„ åç«¯å¤„ç†æµç¨‹åˆ†æ

### 1. **å‰ç«¯ä¸Šä¼ XMLæ–‡ä»¶**
å‰ç«¯é€šè¿‡ `/api/invoice/process-file` ç«¯ç‚¹ä¸Šä¼ XMLæ–‡ä»¶ï¼ˆå¦‚ <mcfile name="invoice1.xml" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/data/invoice1.xml"></mcfile>ï¼‰

### 2. **APIæ¥æ”¶å¤„ç†**
<mcfile name="main.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/main.py"></mcfile> ä¸­çš„ <mcsymbol name="process_invoice_file" filename="main.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/main.py" startline="87" type="function"></mcsymbol> å‡½æ•°æ¥æ”¶æ–‡ä»¶ï¼š

```python
@app.post("/api/invoice/process-file")
async def process_invoice_file(file: UploadFile = File(...), source_system: str = "ERP", db: AsyncSession = Depends(get_db)):
    """å¤„ç†ä¸Šä¼ çš„å‘ç¥¨æ–‡ä»¶"""
    try:
        content = await file.read()
        kdubl_xml = content.decode('utf-8')
        
        # ä½¿ç”¨æ•°æ®åº“ä¼šè¯åˆ›å»ºå‘ç¥¨æœåŠ¡
        invoice_service_with_db = InvoiceProcessingService(db)
        result = await invoice_service_with_db.process_kdubl_invoice(kdubl_xml, source_system)
        return result
```

### 3. **XMLè§£æä¸ºDomain Object**
<mcfile name="kdubl_converter.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/core/kdubl_converter.py"></mcfile> ä¸­çš„ <mcsymbol name="parse" filename="kdubl_converter.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/core/kdubl_converter.py" startline="17" type="function"></mcsymbol> æ–¹æ³•å°†XMLè½¬æ¢ä¸ºDomain Objectï¼š

- è§£æå‘ç¥¨åŸºç¡€ä¿¡æ¯ï¼ˆå‘ç¥¨å·ã€æ—¥æœŸç­‰ï¼‰
- æå–ä¾›åº”å•†å’Œå®¢æˆ·ä¿¡æ¯
- **é‡è¦**ï¼šæå–å•†å“æ˜ç»†ï¼Œæ­¤æ—¶å•†å“é¡¹ç›®**æ²¡æœ‰ç¨ç‡å­—æ®µ**ï¼ˆtax_rateï¼‰

### 4. **è§„åˆ™å¼•æ“å­—æ®µè¡¥å…¨**
<mcfile name="invoice_service.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/services/invoice_service.py"></mcfile> è°ƒç”¨CELè§„åˆ™å¼•æ“è¿›è¡Œå­—æ®µè¡¥å…¨ï¼š

#### 4.1 è§„åˆ™åŒ¹é…
ç³»ç»ŸåŠ è½½ <mcfile name="rules.yaml" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/config/rules.yaml"></mcfile> ä¸­çš„è§„åˆ™ï¼š

```yaml
- id: "completion_item_002"  
  rule_name: "è¡¥å…¨å•†å“ç¨ç‡"
  apply_to: "!has(item.tax_rate) || item.tax_rate == 0"
  target_field: "items[].tax_rate"
  rule_expression: "get_tax_rate(item.description)"
```

#### 4.2 æ¡ä»¶åˆ¤æ–­
<mcfile name="cel_engine.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/core/cel_engine.py"></mcfile> ä¸­çš„ <mcsymbol name="_process_items_rule" filename="cel_engine.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/core/cel_engine.py" startline="323" type="function"></mcsymbol> æ–¹æ³•å¤„ç†æ¯ä¸ªå•†å“é¡¹ç›®ï¼š

- å¯¹äºinvoice1.xmlä¸­çš„æ¯ä¸ªå•†å“ï¼ˆä½æˆ¿ã€æ—©é¤ã€æ™šé¤ã€åœè½¦è´¹ç­‰ï¼‰
- æ£€æŸ¥æ¡ä»¶ï¼š`!has(item.tax_rate) || item.tax_rate == 0`
- ç”±äºXMLä¸­æ²¡æœ‰ç¨ç‡å­—æ®µï¼Œæ¡ä»¶ä¸ºtrueï¼Œè§¦å‘è§„åˆ™

#### 4.3 æ‰§è¡Œget_tax_rateå‡½æ•°
<mcfile name="cel_engine.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/core/cel_engine.py"></mcfile> ä¸­çš„ <mcsymbol name="_process_product_api_functions" filename="cel_engine.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/core/cel_engine.py" startline="119" type="function"></mcsymbol> é¢„å¤„ç†å‡½æ•°è°ƒç”¨ï¼š

```python
# å¤„ç† get_tax_rate() å‡½æ•°
pattern = r'get_tax_rate\(([^)]+)\)'
def replace_get_tax_rate(match):
    param = match.group(1).strip()
    # è¯„ä¼°å‚æ•°è¡¨è¾¾å¼
    param_value = self._evaluate_parameter(param, context)
    if param_value is not None:
        result = product_api.get_tax_rate(str(param_value))
        return str(result)  # è¿”å›æ•°å€¼å­—é¢é‡
    return '0.0'
```

### 5. **Product APIæŸ¥è¯¢ç¨ç‡**
<mcfile name="product_api_service.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/services/product_api_service.py"></mcfile> ä¸­çš„ <mcsymbol name="get_tax_rate" filename="product_api_service.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/services/product_api_service.py" startline="89" type="function"></mcsymbol> æ–¹æ³•ï¼š

```python
@classmethod
def get_tax_rate(cls, description: str, context: Optional[Dict[str, Any]] = None) -> float:
    """è·å–ç¨ç‡"""
    info = cls.get_product_info(description, context)
    return info["tax_rate"]
```

#### ç¨ç‡åŒ¹é…é€»è¾‘ï¼š
- **"ä½æˆ¿"** â†’ åŒ¹é…"ä½æˆ¿"å…³é”®è¯ â†’ è¿”å› **0.06** (6%)
- **"æ—©é¤"/"æ™šé¤"** â†’ åŒ¹é…"é¤é¥®"å…³é”®è¯ â†’ è¿”å› **0.06** (6%)  
- **"åœè½¦è´¹"** â†’ åŒ¹é…"åœè½¦"å…³é”®è¯ â†’ è¿”å› **0.06** (6%)
- **å…¶ä»–å•†å“** â†’ ä½¿ç”¨é»˜è®¤ç¨ç‡ **0.06** (6%)

### 6. **å­—æ®µå€¼è®¾ç½®**
è§„åˆ™å¼•æ“å°†è®¡ç®—å‡ºçš„ç¨ç‡è®¾ç½®åˆ°å¯¹åº”çš„å•†å“é¡¹ç›®ä¸­ï¼š
- `item.tax_rate = 0.06` ï¼ˆä½æˆ¿ã€é¤é¥®ã€åœè½¦è´¹ç­‰ï¼‰

### 7. **ä¸šåŠ¡æ ¡éªŒ**
æ‰§è¡Œå…¶ä»–æ ¡éªŒè§„åˆ™ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œåˆè§„æ€§

### 8. **ç”Ÿæˆå¤„ç†åçš„XML**
<mcsymbol name="build" filename="kdubl_converter.py" path="/Users/qinqiang02/colab/codespace/ai/ng_demo/invoice-system-demo/backend/app/core/kdubl_converter.py" startline="50" type="function"></mcsymbol> æ–¹æ³•å°†è¡¥å…¨åçš„Domain Objectè½¬æ¢å›XMLæ ¼å¼

### 9. **è¿”å›ç»“æœ**
è¿”å›åŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„JSONå“åº”ï¼š
- å¤„ç†æˆåŠŸçŠ¶æ€
- è¡¥å…¨åçš„Domain Object
- å¤„ç†åçš„XML
- æ‰§è¡Œæ—¥å¿—å’Œè¯¦æƒ…

## ğŸ¯ å…³é”®æŠ€æœ¯ç‚¹

1. **CELå¼•æ“é›†æˆ**ï¼šä½¿ç”¨Google CELå¼•æ“å¤„ç†å¤æ‚çš„ä¸šåŠ¡è§„åˆ™è¡¨è¾¾å¼
2. **å‡½æ•°é¢„å¤„ç†**ï¼šå°†è‡ªå®šä¹‰å‡½æ•°ï¼ˆå¦‚get_tax_rateï¼‰è½¬æ¢ä¸ºCELå¯æ‰§è¡Œçš„è¡¨è¾¾å¼
3. **å•†å“APIæ¨¡æ‹Ÿ**ï¼šé€šè¿‡å…³é”®è¯åŒ¹é…æ¨¡æ‹Ÿå¤–éƒ¨APIæŸ¥è¯¢å•†å“ç¨ç‡
4. **è§„åˆ™ä¼˜å…ˆçº§**ï¼šæ”¯æŒå¤šä¸ªè§„åˆ™æŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œ
5. **æ•°ç»„å¤„ç†**ï¼šç‰¹æ®Šå¤„ç†`items[]`è¯­æ³•ï¼Œå¯¹æ¯ä¸ªå•†å“é¡¹ç›®åº”ç”¨è§„åˆ™

è¿™ä¸ªæµç¨‹å±•ç¤ºäº†ç°ä»£å‘ç¥¨ç³»ç»Ÿå¦‚ä½•é€šè¿‡è§„åˆ™å¼•æ“å®ç°æ™ºèƒ½åŒ–çš„å­—æ®µè¡¥å…¨ï¼Œå¤§å¤§å‡å°‘äº†æ‰‹å·¥å½•å…¥çš„å·¥ä½œé‡ã€‚
        